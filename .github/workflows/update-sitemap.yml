name: Update Sitemap

on:
  schedule:
    - cron: '*/5 * * * *' # Executa a cada 5 minutos
  workflow_dispatch: # Permite execução manual

jobs:
  update-sitemap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necessário para histórico completo do Git

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Generate random delay (20-40 minutes)
        id: random-delay
        run: |
          DELAY=$(( ( RANDOM % 21 ) + 20 )) # Gera número aleatório entre 20 e 40
          echo "Delaying for $DELAY minutes"
          echo "delay=$DELAY" >> $GITHUB_OUTPUT

      - name: Wait for random delay
        run: sleep ${{ steps.random-delay.outputs.delay }}m

      - name: Update sitemap with current date
        run: |
          CURRENT_DATE=$(date -u +"%Y-%m-%d")
          sed -i "s/<lastmod>[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}/<lastmod>$CURRENT_DATE/" sitemap.xml

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add sitemap.xml
          git commit -m "Update sitemap lastmod to $CURRENT_DATE"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
